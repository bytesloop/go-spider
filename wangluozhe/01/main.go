package main

import (
	"encoding/json"
	"fmt"
	"io/ioutil"
	"net/http"
	"strconv"
	"strings"
	"time"

	"github.com/robertkrimen/otto"
)

func check(err error) {
	if err != nil {
		panic(err)
	}
}

// 执行js文件
func execjs() string {
	bytes, err := ioutil.ReadFile("./3.js")
	check(err)
	vm := otto.New()
	_, err = vm.Run(string(bytes))
	check(err)
	value, err := vm.Call("getSign", nil)
	check(err)
	return value.String()
}

// 在线 JSON to Go Struct https://transform.tools/json-to-go
type NumData struct {
	Data []struct {
		Value int `json:"value"`
	} `json:"data"`
}

// post请求
func get_signature(page int) int {
	url := "http://spider.wangluozhe.com/challenge/api/1"
	method := "POST"
	payload := strings.NewReader(`page=` + strconv.Itoa(page) + `&count=10&_signature=` + execjs())
	client := &http.Client{}
	req, err := http.NewRequest(method, url, payload)
	check(err)

	req.Header.Add("Pragma", "no-cache")
	req.Header.Add("Cache-Control", "no-cache")
	req.Header.Add("Accept", "application/json, text/javascript, */*; q=0.01")
	req.Header.Add("DNT", "1")
	req.Header.Add("X-Requested-With", "XMLHttpRequest")
	req.Header.Add("User-Agent", "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/97.0.4692.71 Safari/537.36 Edg/97.0.1072.62")
	req.Header.Add("Content-Type", "application/x-www-form-urlencoded; charset=UTF-8")
	req.Header.Add("Origin", "http://spider.wangluozhe.com")
	req.Header.Add("Referer", "http://spider.wangluozhe.com/challenge/1")
	req.Header.Add("Accept-Language", "en,zh-CN;q=0.9,zh;q=0.8,en-GB;q=0.7,en-US;q=0.6,zh-TW;q=0.5")
	req.Header.Add("Cookie", "session=067ab14c-6782-492d-b896-dcfe84af7d8e.OMiVVCs55dHWTPWE9vCb4AzSVj4")

	res, err := client.Do(req)
	check(err)
	defer res.Body.Close()
	fmt.Printf("res.StatusCode: %d\n", res.StatusCode)
	body, err := ioutil.ReadAll(res.Body)
	check(err)
	//fmt.Println(string(body))

	// 解析json
	var numData NumData
	err = json.Unmarshal(body, &numData)
	check(err)
	total := 0
	for _, num := range numData.Data {
		total += num.Value
	}
	fmt.Printf("Page: %d, Total: %d\n", page, total)
	return total
}

func main() {
	// https://gobyexample.com/goroutines
	go func(msg string) {
		fmt.Println(msg)
	}("going")
	// https://gobyexample.com/channels
	messages := make(chan string)
	go func() { messages <- "ping" }()
	msg := <-messages
	fmt.Println(msg)

	result := 0
	for i := 1; i < 1; i++ {
		result += get_signature(i)
		time.Sleep(1 * time.Second)
	}
	fmt.Printf("Sum of the total number of 100 pages: %d\n", result)
	// js数组
	iiIIilii := [...]string{
		//"\x6a\x73\x6a\x69\x61\x6d\x69.\x63\x6f\x6d.\x76\x36", //第一个后面被删除掉了
		"\x73\x65\x74\x49\x6e\x74\x65\x72\x76\x61\x6c",
		"\x6a\x73\x6a",
		"\x69\x61\x6d",
		"\x75\x6e\x64\x65\x66\x69",
		"\x6e\x65\x64",
		"\x69\x2e\x63\x6f\x6d\x2e\x76",
		"\x6c\x65\x6e\x67\x74\x68",
		"\x70\x75\x73\x68",
		"\x61\x70\x70\x6c\x79",
		"\x62\x79\x74\x65\x64\x5f\x61\x63\x72\x61\x77\x6c\x65\x72",
		"\x73\x69\x67\x6e",
		"\x63\x72\x65\x61\x74\x65\x45\x6c\x65\x6d\x65\x6e\x74",
		"\x70\x61\x72\x73\x65",
		"\x74\x6f\x53\x74\x72\x69\x6e\x67",
		"\x31\x32\x33\x34\x35\x36\x37\x38\x39\x61\x62\x63\x64\x65\x66\x67\x68\x69\x67\x6b\x6c\x6d\x6e\x6f\x70\x71\x72\x73\x74\x75\x76\x77\x78\x79\x7a",
		"\x66\x75\x6e\x63\x74\x69\x6f\x6e\x20\x2a\x5c\x28\x20\x2a\x5c\x29",
		"\x5c\x2b\x5c\x2b\x20\x2a\x28\x3f\x3a\x28\x3f\x3a\x5b\x61\x2d\x7a\x30\x2d\x39\x41\x2d\x5a\x5f\x5d\x29\x7b\x31\x2c\x38\x7d\x7c\x28\x3f\x3a\x5c\x62\x7c\x5c\x64\x29\x5b\x61\x2d\x7a\x30\x2d\x39\x5f\x5d\x7b\x31\x2c\x38\x7d\x28\x3f\x3a\x5c\x62\x7c\x5c\x64\x29\x29",
		"\x69\x6e\x69\x74",
		"\x74\x65\x73\x74",
		"\x63\x68\x61\x69\x6e",
		"\x69\x6e\x70\x75\x74",
		"\x72\x65\x74\x75\x72\x6e\x20\x28\x66\x75\x6e\x63\x74\x69\x6f\x6e\x28\x29\x20",
		"\x7b\x7d\x2e\x63\x6f\x6e\x73\x74\x72\x75\x63\x74\x6f\x72\x28\x22\x72\x65\x74\x75\x72\x6e\x20\x74\x68\x69\x73\x22\x29\x28\x20\x29",
		"\x63\x6f\x6e\x73\x6f\x6c\x65",
		"\x6c\x6f\x67",
		"\x77\x61\x72\x6e",
		"\x64\x65\x62\x75\x67",
		"\x69\x6e\x66\x6f",
		"\x65\x72\x72\x6f\x72",
		"\x65\x78\x63\x65\x70\x74\x69\x6f\x6e",
		"\x74\x72\x61\x63\x65",
		"\x64\x65\x66\x69\x6e\x65\x50\x72\x6f\x70\x65\x72\x74\x79",
		"\x63\x6f\x64\x65",
		"\x5f\x73\x69\x67\x6e\x61\x74\x75\x72\x65",
		"\x66\x75\x6e\x63\x74\x69\x6f\x6e\x20\x65\x76\x61\x6c\x28\x29\x20\x7b\x20\x5b\x6e\x61\x74\x69\x76\x65\x20\x63\x6f\x64\x65\x5d\x20\x7d",
		"\x66\x75\x6e\x63\x74\x69\x6f\x6e\x20\x74\x6f\x53\x74\x72\x69\x6e\x67\x28\x29\x20\x7b\x20\x5b\x6e\x61\x74\x69\x76\x65\x20\x63\x6f\x64\x65\x5d\x20\x7d",
		"\x67\x6e\x61\x74\x75\x72\x65\x20\x3d\x20\x77\x69\x6e\x64\x6f\x77\x2e\x62\x79\x74\x65\x64\x5f\x61\x63\x72\x61\x77\x6c\x65\x72\x28\x77\x69\x6e\x64\x6f\x77\x2e\x73\x69\x67\x6e\x28\x29\x29",
		"\x67\x6e\x61\x74\x75\x72\x65\x20\x3d\x20\x77\x69\x6e\x64\x6f\x77\x2e\x62\x79\x74\x65\x64\x5f\x61\x63\x72\x61\x77\x6c\x65\x72\x73\x28\x77\x69\x6e\x64\x6f\x77\x2e\x73\x69\x67\x6e\x73\x28\x29\x29",
		"\x61\x62\x63",
		"\x39\x30\x30\x31\x35\x30\x39\x38\x33\x63\x64\x32\x34\x66\x62\x30\x64\x36\x39\x36\x33\x66\x37\x64\x32\x38\x65\x31\x37\x66\x37\x32",
		"\x77\x69\x6e\x64\x6f\x77",
		"\x2e\x5f\x73\x69",
		"\x63\x6f\x6e\x63\x61\x74",
		"\x75\x73\x65\x72\x41\x67\x65\x6e\x74",
		"\x66\x75\x6e\x63\x74\x69\x6f\x6e\x20\x73\x65\x74\x49\x6e\x74\x65\x72\x76\x61\x6c\x28\x29\x20\x7b\x20\x5b\x6e\x61\x74\x69\x76\x65\x20\x63\x6f\x64\x65\x5d\x20\x7d",
		"\x63\x68\x61\x72\x43\x6f\x64\x65\x41\x74",
		"\x66\x72\x6f\x6d\x43\x68\x61\x72\x43\x6f\x64\x65",
		"\x64\x6f\x63\x75\x6d\x65\x6e\x74",
		"\x6c\x6f\x63\x61\x74\x69\x6f\x6e",
		"\x68\x72\x65\x66",
		"\x61\x76\x61\x69\x6c\x48\x65\x69\x67\x68\x74",
		"\x30\x31\x32\x33\x34\x35\x36\x37\x38\x39\x41\x42\x43\x44\x45\x46",
		"\x30\x31\x32\x33\x34\x35\x36\x37\x38\x39\x61\x62\x63\x64\x65\x66",
		"\x63\x68\x61\x72\x41\x74",
		"\x41\x42\x43\x44\x45\x46\x47\x48\x49\x4a\x4b\x4c\x4d\x4e\x4f\x50\x51\x52\x53\x54\x55\x56\x57\x58\x59\x5a\x61\x62\x63\x64\x65\x66\x67\x68\x69\x6a\x6b\x6c\x6d\x6e\x6f\x70\x71\x72\x73\x74\x75\x76\x77\x78\x79\x7a\x30\x31\x32\x33\x34\x35\x36\x37\x38\x39\x2b\x2f",
		"\x67\x65\x74\x5f\x73\x69\x67\x6e",
		"\x73\x74\x72\x69\x6e\x67",
		"\x63\x6f\x6e\x73\x74\x72\x75\x63\x74\x6f\x72",
		"\x64\x65\x62\x75\x67\x67\x65\x72\x3b",
		"\x63\x6f\x75\x6e\x74\x65\x72",
		"\x64\x65\x62\x75",
		"\x67\x67\x65\x72",
		"\x63\x61\x6c\x6c",
		"\x61\x63\x74\x69\x6f\x6e",
		"\x73\x74\x61\x74\x65\x4f\x62\x6a\x65\x63\x74",
		"\x6a\x73\x6a\x69\x61\x66\x6e\x77\x6d\x69\x2e\x63\x52\x77\x64\x6f\x6d\x2e\x76\x36\x47\x4b\x62\x77\x4b\x72\x52\x46\x43\x74\x53\x43\x3d\x3d",
	}
	fmt.Println(len(iiIIilii))
	// 读取文件 https://gobyexample.com/reading-files
	// dat, err := os.ReadFile("./1.js")
	// check(err)
	// jsStr := string(dat)
	// // fmt.Print(string(dat))
	// // 正则查找 https://gobyexample.com/regular-expressions https://studygolang.com/articles/10294
	// re := regexp.MustCompile(`liIIIi11\('(\w+)'\)`)
	// matchs := re.FindAllStringSubmatch(jsStr, -1)
	// fmt.Println(len(matchs)) // 132
	// for _, v := range matchs {
	// 	// 16进制字符串转换成数字
	// 	if s, err := strconv.ParseInt(v[1], 16, 32); err == nil {
	// 		//fmt.Printf("%s|%s|%s|\n", v[0], v[1], iiIIilii[s])
	// 		rStr := "'" + strings.Replace(iiIIilii[s], "\\x", "", -1) + "'"
	// 		jsStr = strings.Replace(jsStr, v[0], strings.Replace(rStr, "\\", "\\\\", -1), -1)
	// 	}
	// }
	// jsStr = strings.Replace(jsStr, "iï½‰ l", "iｉl", -1)
	// 写入文件 https://gobyexample-cn.github.io/writing-files
	// f, err := os.Create("./2.js")
	// check(err)
	// defer f.Close()

	// n, err := f.WriteString(jsStr)
	// fmt.Printf("wrote %d bytes\n", n)
	// f.Sync()
}
